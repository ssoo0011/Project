<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" type="text/css">
    <title>Title</title>
</head>
<body>
<a th:href="@{/home/}">홈</a>
<div class="wrap">
    <!-- 게시글 -->
    <h2 th:text="${post.title}"></h2>
    <span th:if="${post.pub == 'f'}" th:text="비공개게시물입니다." style="color: #ff0000"></span>
    <div class="card my-3">
        <div class="card-body">
            <span th:text="|조회수 : ${post.getVisitPost()}|"></span>
            <span th:text="|글쓰니 : ${post.writer}|"></span>
            <div class="card-text" style="white-space: pre-line;" th:text="${post.content}"></div>
            <div th:each="postFile : ${postFileList}">
                <img style="width: 30%" th:src="@{/files}+${postFile.fileName}">
            </div>
            <div class="d-flex justify-content-end">
                <div class="badge bg-light text-dark p-2 text-start">
                    <div th:text="${#temporals.format(post.postDate, 'yyyy-MM-dd')}"></div>
                </div>
                <a th:if="${session.loginId == post.writer}" th:text="수정하기"
                   th:href="@{|/post/modify/${post.bno}|}">수정하기</a>
                <a th:if="${session.loginId == post.writer}" th:text="삭제하기"
                   th:href="@{|/post/delete/${post.bno}|}">삭제하기</a>
            </div>
<!--            추천-->
            <a href="javascript:void(0);" class="btn btn-sm btn-outline-secondary"
               th:href="@{|/post/vote/${post.bno}|}" id="voteLink">
                추천
                <span class="badge rounded-pill bg-success" th:text="${post.likeNum}"></span>
            </a>
            <div id="likeNum" th:text="${post.likeNum}">추천</div>
        </div>
    </div>
    <!--     댓글의 갯수 표시-->
    <div class="container my-3">
        <h5 class="border-bottom my-3 py-2"
            th:text="|${#lists.size(post.replyList)}개의 댓글 있습니다.|"></h5>
        <!-- 댓글 반복 시작 -->
        <div class="card my-3" th:each="reply, replyStat : ${post.replyList}" id="wrap">
            <div class="card-body">
                <div th:text="${reply.replyId}"></div>
                <div th:value="|rno${reply.rno}|" th:id="${replyStat.index}" style="display: none">[[${reply.rno}]]
                </div>
                <div class="card-text" style="white-space: pre-line;" th:text="${reply.content}"
                     th:id="|reply${replyStat.index}|"></div>
                <!--댓글수정-->
                <div th:id="|modifyF${replyStat.index}|" class="moF">
                <textarea rows="3" class="form-control" th:id="|modifyReply${replyStat.index}|" name="modifyContent"
                          placeholder="댓글"
                          th:value="${reply.content}">[[${reply.content}]]</textarea>
                    <button type="button" class="modifyBtn">수정완료</button>
                </div>
                <!--수정완료-->
                <div class="d-flex justify-content-end">
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div th:text="${#temporals.format(reply.replyDate, 'yyyy-MM-dd')}"></div>
                    </div>
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div th:if="${session.loginId == reply.replyId}">
                            <button class="modiBtn" th:id="${replyStat.index}"> 댓글 수정</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--     답변 반복 끝-->
    <!--     답변 작성-->
    <form th:action="@{|/reply/create/${post.bno}|}" method="post" class="my-3" id="replyForm">
        <div class="container my-3">
            <div class="card my-3">
                <div class="card-body">
                    <textarea rows="3" class="form-control" id="replyContent" name="content"
                              placeholder="댓글"></textarea>
                    <input type="button" value="댓글등록" onclick="replyFun()" class="btn btn-primary my-2" id="replyBtn">
                </div>
            </div>
        </div>
    </form>
</body>
</html>
<script th:inline="javascript">
    /*<![CDATA[*/
    var loginId = /*[[${session.loginId}]]*/
    var bno = /*[[${post.bno}]]*/
    var a = 0;
    var loginHref = /*[[@{/login}]]*/

    $(function () {
        $('.moF').hide()
    })

    $('#replyBtn').on('click', function () {
        if ($('#replyContent').val() == '') {
            alert('내용을 입력하세요')
        } else {
            replyFormCon()
        }
    })

    function replyFormCon() {
        if (loginId != null) {
            $('#replyBtn').attr('type', 'submit')
        } else {
            alert('로그인하세요')
            $('#replyForm').attr({
                action: '/login',
                method: 'get'
            })
            $('#replyBtn').attr('type', 'submit')
        }
    }

    //수정버튼 누르면 폼태그 액션 수정하는 데로 이동, 버튼 타입 서브밋으로 변경
    $('#listBtn').on('click', function () {

        $('#postDetailForm').attr('action', '/post/list')
        $('#listBtn').attr('type', 'submit')
    })

    //댓글 수정 버튼 누르면 수정폼 뜨게
    $('.modiBtn').on('click', function () {
        let idx = $(this).attr('id')
        a = idx;
        // alert(a)
        $('#modifyF' + idx).show()
    })

    $('.modifyBtn').on('click', function () {

        var content = $('#modifyReply' + a).val();
        var rno = $('#' + a).text()

        $.ajax({
            url: '/reply/modify/' + rno,
            type: 'post',
            data: {
                content: content,
                rno: rno,
                bno: bno
            },
            success: function (cnt) {
                alert('댓글 수정 완료')
                $('.moF').hide()
                $('#reply' + a).text(content)
            },
            error: function () {
                alert("에러입니다.")
            }
        })
    })

    $('.recommend').click(function() {
        if(confirm("정말로 추천하시겠습니까?")) {
            location.href = $(this).data('uri');
        }
    });
    $("#voteLink").on('click', function (){
        if (loginId == null){
            alert('로그인 후 사용하세요')
            $("#voteLink").attr('href', loginHref)
        }
    })

    /*]]>*/
</script>

